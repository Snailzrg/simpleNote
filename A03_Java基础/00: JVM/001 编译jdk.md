[toc]

## jdk编译

>最近在看jvm相关  准备编译jdk7u jdk8
>
>http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/a7ef81ab119b
>
>一些常见错误解决
>
>https://blog.csdn.net/weixin_34007020/article/details/93019192?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EOPENSEARCH%7Edefault-5.control&dist_request_id=1331979.21938.16187018629059223&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EOPENSEARCH%7Edefault-5.control

## 1.1: CenterOs

- 准备依赖

```
yum install -y mercurial
yum install -y ant ant-nodeps
yum install -y libX11* libX*
yum install -y libXi-devel libXtst-devel libXt-devel freetype* 
yum install -y alsa-lib-devel cups-devel
yum install -y gcc gcc-c++
```

- getSource.sh

```
- hg clone http://hg.openjdk.java.net/jdk7u/jdk7u-dev
- hg clone http://hg.openjdk.java.net/jdk8u/jdk8u-dev
chmod 755 get_source.sh 
./get_source.sh 
```

- 由于源码部分由c部分由java 需要jdk环境 （**bootstrap jdk ，编译java文件使用**）

## 执行编译

执行之前先把Bootstrap JDK加到环境变量中去
网上很多帖子在这一步会给configure增加很多参数，比如Bootstrap JDK的路径啊alsa的路径之类的，实际上如果是通过yum安装alsa这些依赖，并在path中增加了Bootstrap JDK的bin目录，这些都不用加

```text
export PATH=/data/jdkbuild/bootstrap_jdk/jdk1.7.0_80/bin:$PATH 
xport PATH=/home/snailzrg/data/jdkbuild/bootstrap_jdk/jdk1.7.0_80/bin:$PATH 
java -version 
bash ./configure --enable-debug --with-target-bits=64
```

sudo bash configure --with-target-bits=64 --with-boot-jdk=/home/snailzrg/data/jdkbuild/bootstrap_jdk/jdk1.7.0_80/ --with-debug-level=slowdebug --enable-debug-symbols ZIP_DEBUGINFO_FILES=0

这个候时如果  make sanity pass通过了 但是make报错

>  export ALT_BOOTDIR=/data/jdkbuild/bootstrap_jdk/jdk1.7.0_80

make clean 

make all

## 1.2: Ubutun

 1.安装依赖

    sudo apt-get install build-essential gawk m4 libasound2-dev libcups2-dev libxrender-dev xorg-dev xutils-dev x11proto-print-dev binutils libmotif-common libmotif-dev ant
    sudo apt-get install libx11-dev
    sudo apt-get install libxt-dev
    sudo apt-get install libxext-dev
    sudo apt-get install libxtst-dev
    
    ## 安装ant 官网下载
    tar -xf apache-ant-1.9.13-bin.tar.gz 
    sudo mv apache-ant-1.9.13 /opt/ 
    sudo vim /etc/profile
    
    ## vim /etc/profile ===>配置后 source /etc/profile 
    export ANT_HOME=/home/snailzrg/data/soft/apache-ant-1.9.15
    export JAVA_HOME=/home/snailzrg/data/jdkbuild/bootstrap_jdk/jdk1.7.0_80
    export PATH=$JAVA_HOME/bin:$PATH:$ANT_HOME/bin
    export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar

> ## 检查环境 <==> 在编译jdk7中的 make sanity
>
> sudo bash configure --with-target-bits=64 --with-boot-jdk=/home/snailzrg/data/jdkbuild/bootstrap_jdk/jdk1.7.0_80/ --with-debug-level=slowdebug --enable-debug-symbols ZIP_DEBUGINFO_FILES=0

- 脚本build.sh

    export LANG=C
    ## BootStrapJdk 安装
    export ALT_BOOTDIR=/home/snailzrg/data/jdkbuild/bootstrap_jdk/jdk1.7.0_80
    
    ## 允许自动下载依赖
    export ALLOW_DOWNLOADS=true
    
    ## 并行编译的线程数，设置成cpu的核心数即可
    export HOTSPOT_BUILD_JOBS=2
    export ALT_PARALLEL_COMPILE_JOBS=2
    
    ## 比较本次版本和上次版本的差异 这对于我们没有什么意义
    ## 必须设置成false 否则 make sanity 检查会报错 缺少先前版本jdk的映射错误
    ## 如果已经设置dev或者 DEV_ONLY=true，这个不显示设置也可
    export SKIP_COMPARE_IMAGES=true
    
    ## 使用预编译头文件 不加这个编译会慢一些
    export USE_PRECOMPILED_HEADER=true
    
    ## 要编译的内容
    export BUILD_LANGTOOLS=true
    #export BUILD_JAXP=false
    #export BUILD_JAXWS=false
    #export BUILD_CORBA=false
    export BUILD_HOTSPOT=true 
    export BUILD_JDK=true
    
    ## 要编译的版本
    #export SKIP_DEBUG_BUILD=false
    #export SKIP_FASTDEBUG_BUILD=true
    #export DEBUG_NAME=debug
    
    ## 把它设置成false可以避开javaws和浏览器java插件之间的部分的build
    BUILD_DEPLOY=false
    
    ##把它设置成false就不会出现build安装包。因为安装包里会出现一些奇怪的依赖
    ## 但是即使不build它自己也已经能得到完整的jdk映像，
    BUILD_INSTALL=false
    
    
    ## ubutun编译jdk7报错check_os_version
    SUPPORTED_OS_VERSION=2.4% 2.5% 2.6% 3% 4% 5%
    DISABLE_HOTSPOT_OS_VERSION_CHECK=ok
    
    ## 编译结构所存放的路径
    export ALT_OUTPITDIR=/home/snailzrg/data/jdkbuild/jdk8u-dev/build
    
    ## 这两个环境变量也需要去掉 
    unset JAVA_HOME
    unset CLASSPATH
    
    ##
    #export PATH=/home/snailzrg/data/jdkbuild/bootstrap_jdk/jdk1.7.0_80/bin:$PATH 
    make 2>&1 |tee $ALT_OUTPITDIR/build.log
    
    # export ANT_HOME=/home/snailzrg/data/soft/apache-ant-1.9.15
    # export JAVA_HOME=/home/snailzrg/data/jdkbuild/bootstrap_jdk/jdk1.7.0_80
    # export PATH=$JAVA_HOME/bin:$PATH:$ANT_HOME/bin
    # export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar

 ln -s /home/snailzrg/data/jdkbuild/jdk8u-dev/build/linux-x86_64-normal-server-release/jdk/bin     /home/snailzrg/snap/eclipse/48/jre/



 ln -s /home/snailzrg/data/jdkbuild/jdk8u-dev/build/linux-x86_64-normal-server-release/jdk/bin  /opt/eclipse-jee/eclipse/jre/

## 1.3 后记

> 折腾了两天 趟了一堆坑，常见的问题上面url由总结 更多时不同的问题
>
> 最好根据官方README-builds.html   
>
> 虚拟机内存大小 swap交换区大小也影响结果
>
> - 目前 ubutun18 成功编译openjdk8， openjdk7编译失败*** This OS is not supported: Linux snailzrg-virtual-machine 5.4.0-65-generic 尝试多次无解......
> - Centeros7 成功编译openjdk7 ，openjdk8编译失败

![image-20210419003708022](https://gitee.com/snailzrg/snail_img/raw/master/picgo_snail_img/image-20210419003708022.png)