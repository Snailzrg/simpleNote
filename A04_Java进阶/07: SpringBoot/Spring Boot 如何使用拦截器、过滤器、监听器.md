[toc]

## Spring Boot å¦‚ä½•ä½¿ç”¨æ‹¦æˆªå™¨ã€è¿‡æ»¤å™¨ã€ç›‘å¬å™¨ï¼Ÿ

ç‚¹å‡»å…³æ³¨ ğŸ‘‰ [JavaåŸºåŸº](javascript:void(0);) *å‰å¤©*

ç‚¹å‡»ä¸Šæ–¹â€œJavaåŸºåŸºâ€ï¼Œé€‰æ‹©â€œè®¾ä¸ºæ˜Ÿæ ‡â€

åšç§¯æçš„äººï¼Œè€Œä¸æ˜¯ç§¯æåºŸäººï¼

æºç ç²¾å“ä¸“æ 

- [åŸåˆ› | Java 2020 è¶…ç¥ä¹‹è·¯ï¼Œå¾ˆè‚~](http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21#wechat_redirect)
- [ä¸­æ–‡è¯¦ç»†æ³¨é‡Šçš„å¼€æºé¡¹ç›®](http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247486264&idx=1&sn=475ac3f1ef253a33daacf50477203c80&chksm=fa497489cd3efd9f7298f5da6aad0c443ae15f398436aff57cb2b734d6689e62ab43ae7857ac&scene=21#wechat_redirect)
- [RPC æ¡†æ¶ Dubbo æºç è§£æ](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484647&idx=1&sn=9eb7e47d06faca20d530c70eec3b8d5c&chksm=fa497b56cd3ef2408f807e66e0903a5d16fbed149ef7374021302901d6e0260ad717d903e8d4&scene=21#wechat_redirect)
- [ç½‘ç»œåº”ç”¨æ¡†æ¶ Netty æºç è§£æ](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247485054&idx=2&sn=9f3b85f7b8454634da6c5c2ded9b4dba&chksm=fa4979cfcd3ef0d9d2dd92d8d1bd8f1553abc6e2095a5d743e0b2c2afe4955ea2bbbd7a4b79d&token=55862109&lang=zh_CN&scene=21#wechat_redirect)
- [æ¶ˆæ¯ä¸­é—´ä»¶ RocketMQ æºç è§£æ](http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247486256&idx=1&sn=81daccd3fcd2953456c917630636fb26&chksm=fa497481cd3efd97d9239f5eab060e49dea9876a6046eadba0effb878d2fb51f3ba5733e4c0b&scene=21#wechat_redirect)
- [æ•°æ®åº“ä¸­é—´ä»¶ Sharding-JDBC å’Œ MyCAT æºç è§£æ](http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247486257&idx=1&sn=4d3c9c675f8833157641a2e0b48e498c&chksm=fa497480cd3efd96fe17975b0b8b141e87fd0a62673e6a30b501460de80b3eb997056f09de08&scene=21#wechat_redirect)
- [ä½œä¸šè°ƒåº¦ä¸­é—´ä»¶ Elastic-Job æºç è§£æ](http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247486258&idx=1&sn=ae5665ae9c3002b53f87cab44948a096&chksm=fa497483cd3efd950514da5a37160e7fd07f0a96f39265cf7ba3721985e5aadbdcbe7aafc34a&scene=21#wechat_redirect)
- [åˆ†å¸ƒå¼äº‹åŠ¡ä¸­é—´ä»¶ TCC-Transaction æºç è§£æ](http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247486259&idx=1&sn=b023cf3dbf97e5da59db2f4ee632f5a6&chksm=fa497482cd3efd9402d71469f71863f71a6998b27e12ca2e00446b8178d79dcef0721d8e570a&scene=21#wechat_redirect)
- [Eureka å’Œ Hystrix æºç è§£æ](http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247486260&idx=1&sn=8f14c0c191d6f8df6eb34202f4ad9708&chksm=fa497485cd3efd93937143a648bc1b530bc7d1f6f8ad4bf2ec112ffe34dee80b474605c22db0&scene=21#wechat_redirect)
- [Java å¹¶å‘æºç ](http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247486261&idx=1&sn=bd69f26aadfc826f6313ffbb95e44ee5&chksm=fa497484cd3efd92352d6fb3d05ccbaebca2fafed6f18edbe5be70c99ba088db5c8a7a8080c1&scene=21#wechat_redirect)

æ¥æºï¼šcnblogs.com/haixiang/p/12000685.html

- è¿‡æ»¤å™¨
- æ‹¦æˆªå™¨
- ç›‘å¬å™¨
- è¿‡æ»¤å™¨ã€æ‹¦æˆªå™¨ã€ç›‘å¬å™¨æ³¨å†Œ
- æ‹¦æˆªå™¨ä¸è¿‡æ»¤å™¨çš„åŒºåˆ«

------

# è¿‡æ»¤å™¨

è¿‡æ»¤å™¨çš„è‹±æ–‡åç§°ä¸º Filter, æ˜¯ Servlet æŠ€æœ¯ä¸­æœ€å®ç”¨çš„æŠ€æœ¯ã€‚

å¦‚åŒå®ƒçš„åå­—ä¸€æ ·ï¼Œè¿‡æ»¤å™¨æ˜¯å¤„äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨èµ„æºæ–‡ä»¶ä¹‹é—´çš„ä¸€é“è¿‡æ»¤ç½‘ï¼Œå¸®åŠ©æˆ‘ä»¬è¿‡æ»¤æ‰ä¸€äº›ä¸ç¬¦åˆè¦æ±‚çš„è¯·æ±‚ï¼Œé€šå¸¸ç”¨ä½œ Session æ ¡éªŒï¼Œåˆ¤æ–­ç”¨æˆ·æƒé™ï¼Œå¦‚æœä¸ç¬¦åˆè®¾å®šæ¡ä»¶ï¼Œåˆ™ä¼šè¢«æ‹¦æˆªåˆ°ç‰¹æ®Šçš„åœ°å€æˆ–è€…åŸºäºç‰¹æ®Šçš„å“åº”ã€‚

## è¿‡æ»¤å™¨çš„ä½¿ç”¨

é¦–å…ˆéœ€è¦å®ç° `Filter`æ¥å£ç„¶åé‡å†™å®ƒçš„ä¸‰ä¸ªæ–¹æ³•

- init æ–¹æ³•ï¼šåœ¨å®¹å™¨ä¸­åˆ›å»ºå½“å‰è¿‡æ»¤å™¨çš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨
- destory æ–¹æ³•ï¼šåœ¨å®¹å™¨ä¸­é”€æ¯å½“å‰è¿‡æ»¤å™¨çš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨
- doFilter æ–¹æ³•ï¼šè¿‡æ»¤çš„å…·ä½“æ“ä½œ

æˆ‘ä»¬å…ˆå¼•å…¥ Maven ä¾èµ–ï¼Œå…¶ä¸­ lombok æ˜¯ç”¨æ¥é¿å…æ¯ä¸ªæ–‡ä»¶åˆ›å»º Logger æ¥æ‰“å°æ—¥å¿—

```
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
```

æˆ‘ä»¬é¦–å…ˆå®ç°æ¥å£ï¼Œé‡å†™ä¸‰ä¸ªæ–¹æ³•ï¼Œå¯¹åŒ…å«æˆ‘ä»¬è¦æ±‚çš„å››ä¸ªè¯·æ±‚äºˆä»¥æ”¾è¡Œï¼Œå°†å…¶å®ƒè¯·æ±‚æ‹¦æˆªé‡å®šå‘è‡³`/online`ï¼Œåªè¦åœ¨å°†MyFilterå®ä¾‹åŒ–åå³å¯ï¼Œæˆ‘ä»¬åœ¨åé¢æ•´åˆä»£ç ä¸­ä¸€èµ·ç»™å‡ºã€‚

```
import lombok.extern.log4j.Log4j2;
import org.springframework.stereotype.Component;

import javax.servlet.*;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpServletResponseWrapper;
import java.io.IOException;

@Log4j2
public class MyFilter implements Filter {

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        log.info("åˆå§‹åŒ–è¿‡æ»¤å™¨");
    }

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse response, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest)servletRequest;
        HttpServletResponseWrapper wrapper = new HttpServletResponseWrapper((HttpServletResponse) response);
        String requestUri = request.getRequestURI();
        log.info("è¯·æ±‚åœ°å€æ˜¯ï¼š"+requestUri);
        if (requestUri.contains("/addSession")
            || requestUri.contains("/removeSession")
            || requestUri.contains("/online")
            || requestUri.contains("/favicon.ico")) {
            filterChain.doFilter(servletRequest, response);
        } else {
            wrapper.sendRedirect("/online");
        }
    }

    @Override
    public void destroy() {
        //åœ¨æœåŠ¡å…³é—­æ—¶é”€æ¯
        log.info("é”€æ¯è¿‡æ»¤å™¨");
    }
}
```

# æ‹¦æˆªå™¨

Javaä¸­çš„æ‹¦æˆªå™¨æ˜¯åŠ¨æ€æ‹¦æˆª action è°ƒç”¨çš„å¯¹è±¡ï¼Œç„¶åæä¾›äº†å¯ä»¥åœ¨ action æ‰§è¡Œå‰åå¢åŠ ä¸€äº›æ“ä½œï¼Œä¹Ÿå¯ä»¥åœ¨ action æ‰§è¡Œå‰åœæ­¢æ“ä½œï¼ŒåŠŸèƒ½ä¸è¿‡æ»¤å™¨ç±»ä¼¼ï¼Œä½†æ˜¯æ ‡å‡†å’Œå®ç°æ–¹å¼ä¸åŒã€‚

- ç™»å½•è®¤è¯ï¼šåœ¨ä¸€äº›åº”ç”¨ä¸­ï¼Œå¯èƒ½ä¼šé€šè¿‡æ‹¦æˆªå™¨æ¥éªŒè¯ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰ç™»å½•æˆ–è€…ç™»å½•å¤±è´¥ï¼Œå°±ä¼šç»™ç”¨æˆ·ä¸€ä¸ªå‹å¥½çš„æç¤ºæˆ–è€…è¿”å›ç™»å½•é¡µé¢ï¼Œå½“ç„¶å¤§å‹é¡¹ç›®ä¸­éƒ½ä¸é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œéƒ½æ˜¯è°ƒå•ç‚¹ç™»å½•ç³»ç»Ÿæ¥å£æ¥éªŒè¯ç”¨æˆ·ã€‚
- è®°å½•ç³»ç»Ÿæ—¥å¿—ï¼šæˆ‘ä»¬åœ¨å¸¸è§åº”ç”¨ä¸­ï¼Œé€šå¸¸è¦è®°å½•ç”¨æˆ·çš„è¯·æ±‚ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚ ipï¼Œæ–¹æ³•æ‰§è¡Œæ—¶é—´ç­‰ï¼Œé€šè¿‡è¿™äº›è®°å½•å¯ä»¥ç›‘æ§ç³»ç»Ÿçš„çŠ¶å†µï¼Œä»¥ä¾¿äºå¯¹ç³»ç»Ÿè¿›è¡Œä¿¡æ¯ç›‘æ§ã€ä¿¡æ¯ç»Ÿè®¡ã€è®¡ç®— PVã€æ€§èƒ½è°ƒä¼˜ç­‰ã€‚
- é€šç”¨å¤„ç†ï¼šåœ¨åº”ç”¨ç¨‹åºä¸­å¯èƒ½å­˜åœ¨æ‰€æœ‰æ–¹æ³•éƒ½è¦è¿”å›çš„ä¿¡æ¯ï¼Œè¿™æ˜¯å¯ä»¥åˆ©ç”¨æ‹¦æˆªå™¨æ¥å®ç°ï¼Œçœå»æ¯ä¸ªæ–¹æ³•å†—ä½™é‡å¤çš„ä»£ç å®ç°ã€‚

## ä½¿ç”¨æ‹¦æˆªå™¨

æˆ‘ä»¬éœ€è¦å®ç° HandlerInterceptor ç±»ï¼Œå¹¶ä¸”é‡å†™ä¸‰ä¸ªæ–¹æ³•ï¼š

- preHandleï¼šåœ¨ Controoler å¤„ç†è¯·æ±‚ä¹‹å‰è¢«è°ƒç”¨ï¼Œè¿”å›å€¼æ˜¯ `boolean`ç±»å‹ï¼Œå¦‚æœæ˜¯`true`å°±è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼›è‹¥è¿”å›`false`ï¼Œåˆ™è¯æ˜ä¸ç¬¦åˆæ‹¦æˆªæ¡ä»¶ï¼Œåœ¨å¤±è´¥çš„æ—¶å€™ä¸ä¼šåŒ…å«ä»»ä½•å“åº”ï¼Œæ­¤æ—¶éœ€è¦è°ƒç”¨å¯¹åº”çš„`response`è¿”å›å¯¹åº”å“åº”ã€‚
- postHandlerï¼šåœ¨ Controoler å¤„ç†è¯·æ±‚æ‰§è¡Œå®Œæˆåã€ç”Ÿæˆè§†å›¾å‰æ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡`ModelAndView`å¯¹è§†å›¾è¿›è¡Œå¤„ç†ï¼Œå½“ç„¶`ModelAndView`ä¹Ÿå¯ä»¥è®¾ç½®ä¸º nullã€‚
- afterCompletionï¼šåœ¨ DispatcherServlet å®Œå…¨å¤„ç†è¯·æ±‚åè¢«è°ƒç”¨ï¼Œé€šå¸¸ç”¨äºè®°å½•æ¶ˆè€—æ—¶é—´ï¼Œä¹Ÿå¯ä»¥å¯¹ä¸€äº›èµ„æºè¿›è¡Œå¤„ç†ã€‚

```
import lombok.extern.log4j.Log4j2;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.HandlerInterceptor;
import org.springframework.web.servlet.ModelAndView;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

@Log4j2
@Component
public class MyInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        log.info("ã€MyInterceptorã€‘è°ƒç”¨äº†:{}", request.getRequestURI());
        request.setAttribute("requestTime", System.currentTimeMillis());
        return true;
    }

    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response,
                           Object handler, ModelAndView modelAndView) throws Exception {
        if (!request.getRequestURI().contains("/online")) {
            HttpSession session = request.getSession();
            String sessionName = (String) session.getAttribute("name");
            if ("haixiang".equals(sessionName)) {
                log.info("ã€MyInterceptorã€‘å½“å‰æµè§ˆå™¨å­˜åœ¨ session:{}",sessionName);
            }
        }
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response,
                                Object handler, Exception ex) throws Exception {
        long duration = (System.currentTimeMillis() - (Long)request.getAttribute("requestTime"));
        log.info("ã€MyInterceptorã€‘[{}]è°ƒç”¨è€—æ—¶:{}ms",request.getRequestURI(), duration);
    }
}
```

# ç›‘å¬å™¨

ç›‘å¬å™¨é€šå¸¸ç”¨äºç›‘å¬ Web åº”ç”¨ç¨‹åºä¸­å¯¹è±¡çš„åˆ›å»ºã€é”€æ¯ç­‰åŠ¨ä½œçš„å‘é€ï¼ŒåŒæ—¶å¯¹ç›‘å¬çš„æƒ…å†µä½œå‡ºç›¸åº”çš„å¤„ç†ï¼Œæœ€å¸¸ç”¨äºç»Ÿè®¡ç½‘ç«™çš„åœ¨çº¿äººæ•°ã€è®¿é—®é‡ç­‰ã€‚

ç›‘å¬å™¨å¤§æ¦‚åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š

- ServletContextListenerï¼šç”¨æ¥ç›‘å¬ ServletContext å±æ€§çš„æ“ä½œï¼Œæ¯”å¦‚æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤ã€‚
- HttpSessionListenerï¼šç”¨æ¥ç›‘å¬ Web åº”ç”¨ç§çš„ Session å¯¹è±¡ï¼Œé€šå¸¸ç”¨äºç»Ÿè®¡åœ¨çº¿æƒ…å†µã€‚
- ServletRequestListenerï¼šç”¨æ¥ç›‘å¬ Request å¯¹è±¡çš„å±æ€§æ“ä½œã€‚

## ç›‘å¬å™¨çš„ä½¿ç”¨

æˆ‘ä»¬é€šè¿‡ `HttpSessionListener`æ¥ç»Ÿè®¡å½“å‰åœ¨çº¿äººæ•°ã€ipç­‰ä¿¡æ¯ï¼Œä¸ºäº†é¿å…å¹¶å‘é—®é¢˜æˆ‘ä»¬ä½¿ç”¨åŸå­intæ¥è®¡æ•°ã€‚

ServletContext,æ˜¯ä¸€ä¸ªå…¨å±€çš„å‚¨å­˜ä¿¡æ¯çš„ç©ºé—´ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸Servletå®¹å™¨ä¹Ÿå°±æ˜¯æœåŠ¡å™¨ä¿æŒä¸€è‡´ï¼ŒæœåŠ¡å™¨å…³é—­æ‰é”€æ¯ã€‚

requestï¼Œä¸€ä¸ªç”¨æˆ·å¯æœ‰å¤šä¸ªï¼›

sessionï¼Œä¸€ä¸ªç”¨æˆ·ä¸€ä¸ªï¼›è€ŒservletContextï¼Œæ‰€æœ‰ç”¨æˆ·å…±ç”¨ä¸€ä¸ªã€‚æ‰€ä»¥ï¼Œä¸ºäº†èŠ‚çœç©ºé—´ï¼Œæé«˜æ•ˆç‡ï¼ŒServletContextä¸­ï¼Œè¦æ”¾å¿…é¡»çš„ã€é‡è¦çš„ã€æ‰€æœ‰ç”¨æˆ·éœ€è¦å…±äº«çš„çº¿ç¨‹åˆæ˜¯å®‰å…¨çš„ä¸€äº›ä¿¡æ¯ã€‚

å› æ­¤æˆ‘ä»¬è¿™é‡Œç”¨ServletContextæ¥å­˜å‚¨åœ¨çº¿äººæ•°`sessionCount`æœ€ä¸ºåˆé€‚ã€‚

æˆ‘ä»¬ä¸‹é¢æ¥ç»Ÿè®¡å½“å‰åœ¨çº¿äººæ•°ï¼š

```
import lombok.extern.log4j.Log4j2;

import javax.servlet.http.HttpSessionEvent;
import javax.servlet.http.HttpSessionListener;
import java.util.concurrent.atomic.AtomicInteger;

@Log4j2
public class MyHttpSessionListener implements HttpSessionListener {

    public static AtomicInteger userCount = new AtomicInteger(0);

    @Override
    public synchronized void sessionCreated(HttpSessionEvent se) {
        userCount.getAndIncrement();
        se.getSession().getServletContext().setAttribute("sessionCount", userCount.get());
        log.info("ã€åœ¨çº¿äººæ•°ã€‘äººæ•°å¢åŠ ä¸º:{}",userCount.get());

        //æ­¤å¤„å¯ä»¥åœ¨ServletContextåŸŸå¯¹è±¡ä¸­ä¸ºè®¿é—®é‡è®¡æ•°ï¼Œç„¶åä¼ å…¥è¿‡æ»¤å™¨çš„é”€æ¯æ–¹æ³•
        //åœ¨é”€æ¯æ–¹æ³•ä¸­è°ƒç”¨æ•°æ®åº“å…¥åº“ï¼Œå› ä¸ºè¿‡æ»¤å™¨ç”Ÿå‘½å‘¨æœŸä¸å®¹å™¨ä¸€è‡´
    }

    @Override
    public synchronized void sessionDestroyed(HttpSessionEvent se) {
        userCount.getAndDecrement();
        se.getSession().getServletContext().setAttribute("sessionCount", userCount.get());
        log.info("ã€åœ¨çº¿äººæ•°ã€‘äººæ•°å‡å°‘ä¸º:{}",userCount.get());
    }
}
```

# è¿‡æ»¤å™¨ã€æ‹¦æˆªå™¨ã€ç›‘å¬å™¨æ³¨å†Œ

## å®ä¾‹åŒ–ä¸‰å™¨

```
import com.anqi.tool.sanqi.filter.MyFilter;
import com.anqi.tool.sanqi.interceptor.MyInterceptor;
import com.anqi.tool.sanqi.listener.MyHttpRequestListener;
import com.anqi.tool.sanqi.listener.MyHttpSessionListener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.web.servlet.FilterRegistrationBean;
import org.springframework.boot.web.servlet.ServletListenerRegistrationBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Autowired
    MyInterceptor myInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(myInterceptor);
    }

    /**
     * æ³¨å†Œè¿‡æ»¤å™¨
     * @return
     */
    @Bean
    public FilterRegistrationBean filterRegistrationBean(){
        FilterRegistrationBean filterRegistration = new FilterRegistrationBean();
        filterRegistration.setFilter(new MyFilter());
        filterRegistration.addUrlPatterns("/*");
        return filterRegistration;
    }

    /**
     * æ³¨å†Œç›‘å¬å™¨
     * @return
     */
    @Bean
    public ServletListenerRegistrationBean registrationBean(){
        ServletListenerRegistrationBean registrationBean = new ServletListenerRegistrationBean();
        registrationBean.setListener(new MyHttpRequestListener());
        registrationBean.setListener(new MyHttpSessionListener());
        return registrationBean;
    }
}
```

## æµ‹è¯•

```
import com.anqi.tool.sanqi.listener.MyHttpSessionListener;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

@RestController
public class TestController {

    @GetMapping("addSession")
    public String addSession(HttpServletRequest request) {
        HttpSession session = request.getSession();
        session.setAttribute("name", "haixiang");
        return "å½“å‰åœ¨çº¿äººæ•°" + session.getServletContext().getAttribute("sessionCount") + "äºº";
    }

    @GetMapping("removeSession")
    public String removeSession(HttpServletRequest request) {
        HttpSession session = request.getSession();
        session.invalidate();
        return "å½“å‰åœ¨çº¿äººæ•°" + session.getServletContext().getAttribute("sessionCount") + "äºº";
    }

    @GetMapping("online")
    public String online() {
        return "å½“å‰åœ¨çº¿äººæ•°" + MyHttpSessionListener.userCount.get() + "äºº";
    }

}
```

ä»¥ä¸‹æ˜¯ç›‘å¬è¯·æ±‚çš„ç›‘å¬å™¨

```
import javax.servlet.ServletRequestEvent;
import javax.servlet.ServletRequestListener;
import javax.servlet.http.HttpServletRequest;

public class MyHttpRequestListener implements ServletRequestListener {

    @Override
    public void requestDestroyed(ServletRequestEvent sre) {
        System.out.println("request ç›‘å¬å™¨è¢«é”€æ¯");
    }

    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        HttpServletRequest req = (HttpServletRequest) sre.getServletRequest();
        String requestURI = req.getRequestURI();
        System.out.println(requestURI+"--"+"è¢«è°ƒç”¨");
    }
}
```

# æ‹¦æˆªå™¨ä¸è¿‡æ»¤å™¨çš„åŒºåˆ«

**1.å‚è€ƒæ ‡å‡†**

- è¿‡æ»¤å™¨æ˜¯ JavaEE çš„æ ‡å‡†ï¼Œä¾èµ–äº Servlet å®¹å™¨ï¼Œç”Ÿå‘½å‘¨æœŸä¹Ÿä¸å®¹å™¨ä¸€è‡´ï¼Œåˆ©ç”¨è¿™ä¸€ç‰¹æ€§å¯ä»¥åœ¨é”€æ¯æ—¶é‡Šæ”¾èµ„æºæˆ–è€…æ•°æ®å…¥åº“ã€‚
- æ‹¦æˆªå™¨æ˜¯ SpringMVC ä¸­çš„å†…å®¹ï¼Œä¾èµ–äºwebæ¡†æ¶ï¼Œé€šå¸¸ç”¨äºéªŒè¯ç”¨æˆ·æƒé™æˆ–è€…è®°å½•æ—¥å¿—ï¼Œä½†æ˜¯è¿™äº›åŠŸèƒ½ä¹Ÿå¯ä»¥åˆ©ç”¨ AOP æ¥ä»£æ›¿ã€‚

**2.å®ç°æ–¹å¼**

- è¿‡æ»¤å™¨æ˜¯åŸºäºå›è°ƒå‡½æ•°å®ç°ï¼Œæ— æ³•æ³¨å…¥ ioc å®¹å™¨ä¸­çš„ beanã€‚
- æ‹¦æˆªå™¨æ˜¯åŸºäºåå°„æ¥å®ç°ï¼Œå› æ­¤æ‹¦æˆªå™¨ä¸­å¯ä»¥æ³¨å…¥ ioc å®¹å™¨ä¸­çš„ beanï¼Œä¾‹å¦‚æ³¨å…¥ Redis çš„ä¸šåŠ¡å±‚æ¥éªŒè¯ç”¨æˆ·æ˜¯å¦å·²ç»ç™»å½•ã€‚