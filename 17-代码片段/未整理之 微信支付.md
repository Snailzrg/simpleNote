# wxpay
1 简单操作 from csdn
```
<dependency>
            <groupId>com.github.wxpay</groupId>
            <artifactId>wxpay-sdk</artifactId>
            <version>0.0.3</version>
        </dependency>

https://blog.csdn.net/zoroduyu/article/details/79911278

    /**
     * 微信回调的接口
     * 
     * @param uuid
     * @return
     * @throws Exception
     */
    @RequestMapping(value = "/wxReturnPay")
    public void wxReturnPay(HttpServletResponse response, HttpServletRequest request)
            throws Exception {

        logger.info("****************************************wxReturnPay微信的回调函数被调用******************************");
        String inputLine;
        String notityXml = "";
        request.setCharacterEncoding("UTF-8");
        response.setCharacterEncoding("UTF-8");
        response.setContentType("text/html;charset=UTF-8");
        response.setHeader("Access-Control-Allow-Origin", "*");
        // 微信给返回的东西
        try {
            while ((inputLine = request.getReader().readLine()) != null) {
                notityXml += inputLine;
            }
            request.getReader().close();
        } catch (Exception e) {
            e.printStackTrace();
            logger.info("xml获取失败");
            response.getWriter().write(setXml("fail", "xml获取失败"));
            return;
        }
        if (StringUtils.isEmpty(notityXml)) {
            logger.info("xml为空");
            response.getWriter().write(setXml("fail", "xml为空"));
            return;
        }

        WXService wxService = WXService.getInstance();
        if(!wxService.checkSign(notityXml)) {
            response.getWriter().write(setXml("fail", "验签失败"));
        }
        logger.info("xml的值为：" + notityXml);
        XMLSerializer xmlSerializer = new XMLSerializer(); 
        JSON json = xmlSerializer.read(notityXml);
        logger.info(json.toString());
         JSONObject jsonObject=JSONObject.fromObject(json.toString());
         UnifiedOrderRespose returnPay = (UnifiedOrderRespose) JSONObject.toBean(jsonObject, UnifiedOrderRespose.class);
         logger.info(("转换后的实体bean为："+returnPay.toString()));
         logger.info(("订单号："+returnPay.getOut_trade_no()+"价格："+returnPay.getTotal_fee()));
        if (returnPay.getReturn_code().equals("SUCCESS") && returnPay.getOut_trade_no() != null
                && !returnPay.getOut_trade_no().isEmpty()) {
            double fee = Double.parseDouble(returnPay.getTotal_fee());
            returnPay.setTotal_fee(String.valueOf(fee/100));
            logger.info("微信的支付状态为SUCCESS");
            tbPaymentRecordsService.wxPaySuccess(returnPay);
        }
    }


    /**
     * 微信验签接口
     * 
     * @param out_trade_no
     * @param body
     * @param money
     * @param applyNo
     * @return
     * @throws DocumentException 
     */
    public boolean checkSign(String  strXML) throws DocumentException {
         SortedMap<String, String> smap = new TreeMap<String, String>();
         Document doc = DocumentHelper.parseText(strXML);
         Element root = doc.getRootElement();
         for (Iterator iterator = root.elementIterator(); iterator.hasNext();) {
             Element e = (Element) iterator.next();
             smap.put(e.getName(), e.getText());
         }
         return isWechatSign(smap,config.getKey());
    }


    private boolean isWechatSign(SortedMap<String, String> smap,String apiKey) {
         StringBuffer sb = new StringBuffer();
         Set<Entry<String, String>> es = smap.entrySet();
         Iterator<Entry<String, String>> it = es.iterator();
         while (it.hasNext()) {
             Entry<String, String> entry =  it.next();
             String k = (String) entry.getKey();
             String v = (String) entry.getValue();
             if (!"sign".equals(k) && null != v && !"".equals(v) && !"key".equals(k)) {
                 sb.append(k + "=" + v + "&");
             }
         }
         sb.append("key=" + apiKey);
         /** 验证的签名 */
         String sign = MD5Util.MD5Encode(sb.toString(), "utf-8").toUpperCase();
         /** 微信端返回的合法签名 */
         String validSign = ((String) smap.get("sign")).toUpperCase();
         return validSign.equals(sign);
     }

```
wxService！！！
```
package com.example.ffmpeg;

import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;
import java.util.SortedMap;
import java.util.TreeMap;

import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.dom4j.DocumentHelper;
import org.dom4j.Element;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.github.wxpay.sdk.WXPay;

public class WXService {

    private static Logger logger = LoggerFactory.getLogger(WXService.class);
    private WXPay wxpay;
    private WXPayConfigImpl config;
    private static WXService INSTANCE;  

    private WXService() throws Exception {
        config = WXPayConfigImpl.getInstance();
        wxpay = new WXPay(config);
    }

    public static WXService getInstance() throws Exception {
        if (INSTANCE == null) {
            synchronized (WXPayConfigImpl.class) {
                if (INSTANCE == null) {
                    INSTANCE = new WXService();
                }
            }
        }
        return INSTANCE;
    }

    /**
     * 微信下單接口
     * 
     * @param out_trade_no
     * @param body
     * @param money
     * @param applyNo
     * @return
     */
    public String doUnifiedOrder(String out_trade_no, String body, Double money, String applyNo) {
        String amt = String.valueOf(money * 100);
        HashMap<String, String> data = new HashMap<String, String>();
        data.put("body", body);
        data.put("out_trade_no", out_trade_no);
        data.put("device_info", "web");
        data.put("fee_type", "CNY");
        data.put("total_fee", amt.substring(0, amt.lastIndexOf(".")));
        data.put("spbill_create_ip", config.getSpbillCreateIp());
        data.put("notify_url", config.getNotifUrl());
        data.put("trade_type", config.getTradeType());
        data.put("product_id", applyNo);
        System.out.println(String.valueOf(money * 100));
        // data.put("time_expire", "20170112104120");

        try {
            Map<String, String> r = wxpay.unifiedOrder(data);
            logger.info("返回的参数是" + r);
            return r.get("code_url");
        } catch (Exception e) {
            e.printStackTrace();
            logger.info(e.getMessage());
            return null;
        }
    }

    /**
     * 退款 已测试
     */
    public void doRefund(String out_trade_no, String total_fee) {
        logger.info("退款时的订单号为：" + out_trade_no + "退款时的金额为:" + total_fee);
        String amt = String.valueOf(Double.parseDouble(total_fee) * 100);
        logger.info("修正后的金额为：" + amt);
        logger.info("最终的金额为：" + amt.substring(0, amt.lastIndexOf(".")));
        HashMap<String, String> data = new HashMap<String, String>();
        data.put("out_trade_no", out_trade_no);
        data.put("out_refund_no", out_trade_no);
        data.put("total_fee", amt.substring(0, amt.lastIndexOf(".")));
        data.put("refund_fee", amt.substring(0, amt.lastIndexOf(".")));
        data.put("refund_fee_type", "CNY");
        data.put("op_user_id", config.getMchID());

        try {
            Map<String, String> r = wxpay.refund(data);
            logger.info("退款操作返回的参数为" + r);
        } catch (Exception e) {
            e.printStackTrace();
        }

    }


    /**
     * 微信验签接口
     * 
     * @param out_trade_no
     * @param body
     * @param money
     * @param applyNo
     * @return
     * @throws DocumentException 
     */
    public boolean checkSign(String  strXML) throws DocumentException {
         SortedMap<String, String> smap = new TreeMap<String, String>();
         Document doc = DocumentHelper.parseText(strXML);
         Element root = doc.getRootElement();
         for (Iterator iterator = root.elementIterator(); iterator.hasNext();) {
             Element e = (Element) iterator.next();
             smap.put(e.getName(), e.getText());
         }
         return isWechatSign(smap,config.getKey());
    }


    private boolean isWechatSign(SortedMap<String, String> smap,String apiKey) {
         StringBuffer sb = new StringBuffer();
         Set<Entry<String, String>> es = smap.entrySet();
         Iterator<Entry<String, String>> it = es.iterator();
         while (it.hasNext()) {
             Entry<String, String> entry =  it.next();
             String k = (String) entry.getKey();
             String v = (String) entry.getValue();
             if (!"sign".equals(k) && null != v && !"".equals(v) && !"key".equals(k)) {
                 sb.append(k + "=" + v + "&");
             }
         }
         sb.append("key=" + apiKey);
         /** 验证的签名 */
         String sign = MD5Util.MD5Encode(sb.toString(), "utf-8").toUpperCase();
         /** 微信端返回的合法签名 */
         String validSign = ((String) smap.get("sign")).toUpperCase();
         return validSign.equals(sign);
     }
}
```

WXPayConfigImpl ！！！
```
package com.example.ffmpeg;

import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.InputStream;

import com.github.wxpay.sdk.WXPayConfig;

public class WXPayConfigImpl implements WXPayConfig{

     private byte[] certData;
        private static WXPayConfigImpl INSTANCE;

        private WXPayConfigImpl() throws Exception{
            String certPath = "F:\\weixin\\apiclient_cert.p12";
            File file = new File(certPath);
            InputStream certStream = new FileInputStream(file);
            this.certData = new byte[(int) file.length()];
            certStream.read(this.certData);
            certStream.close();
        }

        public static WXPayConfigImpl getInstance() throws Exception{
            if (INSTANCE == null) {
                synchronized (WXPayConfigImpl.class) {
                    if (INSTANCE == null) {
                        INSTANCE = new WXPayConfigImpl();
                    }
                }
            }
            return INSTANCE;
        }

        public String getAppID() {
            return "你的appid";
        }

        public String getMchID() {
            return "你的商户id";
        }

        public String getKey() {
            return "你设置的key值";
        }

        public String getNotifUrl() {
            return "微信通知回调的url接口";
        }

        public String getTradeType() {
            return "NATIVE";
        }

        public InputStream getCertStream() {
            ByteArrayInputStream certBis;
            certBis = new ByteArrayInputStream(this.certData);
            return certBis;
        }


        public int getHttpConnectTimeoutMs() {
            return 2000;
        }

        public int getHttpReadTimeoutMs() {
            return 10000;
        }

//      IWXPayDomain getWXPayDomain() {
//          return WXPayDomainSimpleImpl.instance();
//      }

        public String getPrimaryDomain() {
            return "api.mch.weixin.qq.com";
        }

        public String getAlternateDomain() {
            return "api2.mch.weixin.qq.com";
        }

        public int getReportWorkerNum() {
            return 1;
        }

        public int getReportBatchSize() {
            return 2;
        }

        public String getSpbillCreateIp() {
            // TODO Auto-generated method stub
            return "192.168.1.1";
        }
}

```
**微信接口访问**

1·执行(消息推送)：https://api.weixin.qq.com/cgi-bin/message/wxopen/template/send?access_token="+accessToken
   返回：{"errcode":0,"errmsg":"ok"}

2·执行(获取微信二维码)：https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token=" + token
   返回：{HTTP/1.1 200 OK [Connection: keep-alive, Cache-Control: no-cache, must-revalidate, Content-Type: image/jpeg, Content-disposition: attachment;          filename="_201712110851590595y8r2nv", Content-Length: 106431] ResponseEntityProxy{[Content-Type: image/jpeg,Content-Length: 106431,Chunked: false]}}

3·执行(获取token)：https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid="+appid+"&secret="+secret
   返回：{"access_token":"13_BDcCPewRXflfUL04V2_Tg2ZPWLzeFn5c0OB60GnrGkU5wP66EESh39kFi499xf7fACD0XzJXIdsVXDrEC5jlTc1LHxlFbJhGEgVgTT5VlXPlLT6YW67HQHAWf-         go84yFbDGPSam2Tl6ggvpJFJGgAIAYCZ","expires_in":7200}